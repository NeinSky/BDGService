# Сервис поздравлений
## 1. Настройка и запуск
Сервис представляет собой приложение, написанное с использованием библиотеки FastAPI, работающее в связке с СУДБ PostgreSQL и SQLAlchemy.

Для развёртывания приложения удобнее всего использовать Docker.

### 1.1 Настройка окружения
В папке backend находится файл .env-example. Необходимо ознакомиться с его содежимым, заполнить и переименовать в .env.

Файл содержит секретную информацию: имя пользователя СУДБ, пароль и ключ.
Важно чтобы пользователь и пароль совпадали с теми, что описаны в файле docker-compose.yml в корне проекта, если приложение запускается при помощи Docker.

Секретный ключ можно сгенерировать при помощи команды в терминале:

`$ openssl rand -hex 32`

Пример ключа:

`a4c1937b4efd1dfe37b63e35eb2a532ee9ab84aa0d41a10ad3f9be8e44e6b4bc`

### 1.2. Файл конфигурации

Файл config.py находится в папке backend. Он не требует редактирования, если вы запускаете контейнер с параметрами по умолчанию.


### 1.3 docker-compose.yml

При желании можно отредактировать файл docker-compose.yml, поменяв названия контейнеров и параметры учётной записи по умолчанию.
Убедитесь, что настройки в docker-compose.yml и config.py совпадают.

### 1.4 Запуск при помощи Docker
Сперва необходимо установить Docker, затем, находясь в корне проекта, выполните 2 команды:

```commandline
$ docker compose build
и
$ docker compose up
```

После запуска контейнеров, можно перейти к документации сервиса по адресу: http://0.0.0.0:8000/docs (адрес по умолчанию)

## 2. Структура проекта
```commandline
| docker-compose.yml
|-- backend       каталог сервиса
    |-- auth      модуль авторизации и аутентификации
    |-- database  модуль работы с базой данных и моделями SQLAlchemy
    |-- routes    содержит роуты и модели pydentic
    |-- tests     тесты приложения
```
## 3. Описание эндпоинтов
```commandline
[Регистрация и авторизация]
POST   /token                       авторизация и получение токена
POST   /register                    регистрация нового пользователя
PATCH  /change_password             изменение пароля

[Административные роуты - требуется авторизация и права администратора]
GET    /admins                      список администраторов сервиса
POST   /admins/users                создание учётной записи
PATCH  /admins/users                изменение учётной записи
DELETE /admins/users/{idx}          удаление учётной записи
PATCH  /admins/users/ban/{idx}      отключение учётной записи
PATCH  /admins/users/unban/{idx}    включение учётной записи
PATCH  /admins/users/promote/{idx}  выдать права администратора
PATCH  /admins/users/demote/{idx}   убрать права администратора

[Пользовательские роуты - требуется авторизация]
GET    /users                       получение списка сотрудников
GET    /users/subscribe/{idx}       подписаться на рассылку сотрудника
GET    /users/unsubscribe/{idx}     отписаться от рассылки сотрудника
GET    /users/subscribe/list        список подписок
GET    /users/alert                 получить уведомление, если у полсотрудника сегодня ДР и пользователь на него подписан
```

## 4. Описание работы сервиса
Предполагается, что пользователь будет взаимодействовать с сервисом при помощи frontend-приложения. Схема работы следующая:


1. Отправляется запрос на роут /register. В запросе передаётся JSON, содержащий информации о пользователе и пароль. 
В случае успеха пользователь получает JSON, содержащий данные новой учётной записи.
2. Отправляется запрос на роут /token, куда в теле передаётся логин и пароль. В случае успеха пользователь получает токен.
3. Далее пользователь передаёт токен в заголовке каждого обращения к пользовательским роутам.

После получения токена пользователь может просматривать список сотрудников и получать базовую информацию о них: имя, почта, ДР и так далее.
Далее он может подписываться, отписываться и просматривать свои подписки. Также он может получать уведомления о днях рождения.
Предполагается, что frontend после авторизации должен обращаться на роут /users/alert и формировать оповещения, если они есть.

Внимание: в данной версии приложения все данные передаются в открытом виде. 
В реальной ситуации информация должна передаваться по защищённому каналу, например, с использованием HTTPS.

## 5. Проверка работы
Проверить работу приложения можно при помощи Swagger, расположенного по адресу http://0.0.0.0:8000/docs

## 6. Запуск тестов
1. Установите все библиотеки из файла requirements.txt в папке backend. Находясь в папке backend выполните команду:
`pip install -r requirements.txt`
2. Установите библиотеку httpx
`pip install httpx`
3. Запустите контейнеры.
4. В файле config.py измените параметр DB_HOST:
`DB_HOST = '0.0.0.0'`
5. Запустите тесты.